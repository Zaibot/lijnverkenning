<!DOCTYPE html>
<html lang="en">

<head>
	<base target="_top">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<title>Lijnverkenning</title>

	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Lexend+Deca:wght@100..900&display=swap" rel="stylesheet">

	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />


	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
		integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
		integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
	<script src="https://cdn.jsdelivr.net/npm/leaflet-geometryutil@0.10.3/src/leaflet.geometryutil.min.js">
	</script>
	<style>
		html,
		body {
			height: 100%;
			margin: 0;

			font-family: "Lexend Deca", sans-serif;
			font-optical-sizing: auto;
			font-weight: 300;
			font-style: normal;

			overflow: hidden;
		}

		body {
			display: grid;
		}

		dialog:open::backdrop {
			background-color: rgb(0 0 0 / 10%);
		}

		dialog:modal {
			background: #ffffff80;
			backdrop-filter: blur(3px);
			border: 6px solid #00000040;
			border-radius: 3px;
		}

		code {
			white-space: pre;
			user-select: all;
			background-color: #ffffff80;
			display: block;
			padding: 0.5rem;
			max-height: 60vh;
			overflow: auto;
			box-sizing: border-box;
		}

		.arrow-icon {
			color: var(--app-map-color);
			font-size: var(--app-map-font-size);
			line-height: 1;
			text-shadow: 1px 1px 2px #000000c0;
			text-shadow: -1px -1px 0px #000000c0, 1px 1px 0px #000000c0, -1px 1px 0px #000000c0, 1px -1px 0px #000000c0;

			&.focus {
				text-shadow: 1px 1px 3px #000000c0, 1px 1px 8px #000000c0;
			}

			&.active {
				color: #eeeeee;
				text-shadow: 1px 1px 3px #000000c0, 1px 1px 8px #000000c0;
			}
		}

		.leaflet-container {
			max-width: 100%;
			max-height: 100%;
			z-index: 0;
		}

		.leaflet-tooltip {
			background-color: #202050;
			border: 1px solid #ffffff;
			border-radius: 0.1rem;
			color: #fff;
			box-shadow: none;
			padding: 0.1rem 0.2rem;
			max-width: 5rem;
			overflow: hidden;
			text-overflow: ellipsis;

			&.app-fav {
				background-color: #502020;
			}
		}

		.leaflet-tooltip-left:before {
			border-left-color: #202050f0;
		}

		.leaflet-tooltip-right:before {
			border-right-color: #202050f0;
		}

		.leaflet-tooltip-top:before {
			border-top-color: #202050f0;
		}

		.leaflet-tooltip-bottom:before {
			border-bottom-color: #202050f0;
		}

		app-trip-ref.app-search-hidden {
			display: none;
		}

		app-keywords {
			color: #a00000;
			max-height: 15rem;
			overflow: hidden;
			text-overflow: ellipsis;
			margin: 0.2rem 0.4rem;
		}

		app-main {
			display: grid;
			grid-template: auto / 1fr 2fr;
			height: 100%;
			grid-template: "side map" auto / 1fr 2fr;

			@media (orientation: portrait) {
				grid-template:
					"side" 3fr
					"map" 2fr / 1fr;
			}
		}

		app-sign {
			display: flex;
			flex-direction: row;
			flex-wrap: wrap;
			gap: 0.25rem;

			app-name {
				color: #102080;
			}
		}

		app-doc {
			flex: 1 1 auto;
			overflow-y: auto;
			box-sizing: border-box;
		}

		app-trip {
			&>header {
				display: flex;
				gap: 0.4rem;
				align-items: center;

				&>app-name {
					flex: 1 1 auto;

					display: flex;
					flex-direction: column;


					&>app-sub-name {
						font-size: 0.7rem;
						color: #7f7fb0;
					}
				}
			}

			app-city {
				padding-left: 0rem;
				position: sticky;
				top: 3rem;
				background-color: #f0f0ff;
				z-index: 0;
			}

			app-stop {
				padding-left: 1rem;
				user-select: none;
			}

		}

		header,
		app-stop,
		app-stop-travel,
		app-city {
			transition: padding 0.2s ease, color 0.6s ease, background-color 0.6s ease, font-size 0.2s ease;
		}

		app-fav {
			transition: padding 0.2s ease, color 0.1s ease, background-color 0.1s ease, font-size 0.2s ease;
		}

		app-main.compact {
			app-trip>header {
				padding: 0.2rem;
			}

			app-trip-ref>header {
				padding: 0.2rem;
			}


			app-trip-ref>app-keywords {
				display: none;
			}


			app-trip-ref>app-bar {
				display: none;
			}

			app-city {
				padding: 0.0rem 0.2rem;
				font-size: 0.8rem;

				color: #404080;
			}

			app-stop {
				padding: 0 0 0.2rem 0;
			}

			app-stop app-fav {
				padding: 0.0rem;
				background-color: #c2c2f9;

				&.selected {
					background-color: #802020;
				}
			}

			app-stop-travel {
				padding: 0 0.2rem 0.2rem 1.5rem;
			}

			app-stop-travel:not(.user) {
				display: none;
			}

			app-preview {
				height: 1.2rem;
				width: 2.4rem;
			}

			grid-template: "side map" auto / 1fr 2fr;

			@media (orientation: portrait) {
				grid-template:
					"side" 8fr
					"map" 4fr / 1fr;
			}

		}

		app-bar {
			display: flex;
			flex-direction: row;
			align-items: center;
			flex-wrap: wrap;
			gap: 0.5rem;
		}

		app-plan {
			app-list {
				display: flex;
				flex-direction: column;
			}

			app-line {
				color: #000000;
			}

			app-name {
				color: #000000;
			}

			span {}

			strong {}
		}

		app-list {
			display: flex;
			flex-direction: column;
			align-items: flex-start;
			flex-wrap: wrap;
		}

		app-spacer {
			flex: 1 1 auto;
		}

		app-trip-ref {
			display: flex;
			flex-direction: row;
			align-items: center;
			justify-items: center;
			flex-wrap: wrap;

			&>header {
				cursor: pointer;
				flex: 1 1 100%;
				display: flex;
				gap: 0.5rem;
				align-items: center;

				&>app-name {
					flex: 1 1 auto;

					display: flex;
					flex-direction: column;
					font-size: 1.2rem;

					&>app-sub-name {
						font-size: 0.7rem;
						color: #7f7fb0;
					}
				}
			}

			&>app-keywords {
				font-size: 0.7rem;
			}

			&>app-bar {
				flex: 1 1 100%;
			}

			app-trip-cell {
				display: flex;
				justify-items: flex-end;
				align-items: center;
				flex: 1 0 100%;
				display: flex;
				flex-direction: row;
				gap: 0.5rem;

				app-city-ref {
					font-weight: inherit;
					color: #40408080;
				}

				app-name {
					color: #404080c0;
				}
			}


			app-stop-ref {
				display: flex;
				flex-direction: row;
				gap: 0.5rem;
				align-items: center;
			}

		}

		app-fav {
			font-weight: 600;
			display: flex;
			align-items: center;
			justify-content: center;
			min-width: 1rem;
			padding: 0.5rem;
			border-radius: 0.2rem;
			color: #e0e0f0;
			background-color: #202050;

			&.selected {
				color: #f0e0e0;
				background-color: #802020;
			}
		}


		app-city {
			font-weight: 600;
			padding: 0.6rem 0.2rem;
			color: #40408080;
			display: flex;
			flex-direction: row;
			gap: 0.5rem;
			align-items: center;

			app-doc & {}
		}


		app-city-ref {
			font-weight: 600;
			padding: 0.2rem;
			color: #40408080;
			display: flex;
			flex-direction: row;
			gap: 0.5rem;
			align-items: center;

			app-doc & {}
		}

		app-trip-ref {
			border: 1px solid #77777740;
			border-radius: 0.5rem;
			background-color: #f0f0ff;

			&:focus {
				background-color: #e0e0f0;
			}

			&>header {
				padding: 0.5rem;
				border-radius: 0.5rem;
				color: #e0e0f0;
				background-color: #202050;


				&>app-name {
					background-color: #e0e0f0;
					background-color: #c0c0f0;
					color: #202050;
					border-radius: 0.25rem;
					padding: 0.5rem;
					text-transform: uppercase;
					font-weight: 500;
				}
			}

			app-stop-ref {
				font-size: 0.8rem;
			}
		}


		app-route {
			&>app-trips {
				display: flex;
				flex-direction: column;
				gap: 1rem;
			}


			&>header {
				display: flex;
				flex-direction: row;
				gap: 1rem;
				padding: 0.5rem;
				border-radius: 0.5rem;
				color: #e0e0f0;
				background-color: #202050;


				&>app-name {
					background-color: #e0e0f0;
					background-color: #c0c0f0;
					color: #202050;
					border-radius: 0.25rem;
					padding: 0.5rem;
					text-transform: uppercase;
					font-weight: 500;
				}
			}
		}

		app-toggle {
			display: flex;
			border-radius: 0.2rem;
			background-color: #555588;
			cursor: pointer;
			padding: 0.1rem;
			user-select: none;

			app-toggle-option {
				flex: 1 1 auto;
				padding: 0.5rem 1.0rem;
				color: #f0f0ff;

				&:not(:first-of-type) {
					border-left: 1px solid #f0f0ff;
				}
			}
		}

		app-stops {
			display: flex;
			flex-direction: column;
			gap: 0.5rem;
		}

		app-stop-travel {
			padding: 0.2rem;
			padding-left: 3.5rem;

			display: flex;
			flex-direction: row;
			gap: 0.5rem;
			align-items: center;


			button {
				flex: 1 1 auto;
				display: flex;
				justify-content: start;
				border: 1px dotted #c0c0f0;
				background-color: transparent;
				color: #08084060;
				padding: 0.25rem;
				font-size: 1.0rem;
			}

			&.focus {
				button {
					font-weight: 500;
					color: #080840;
					text-decoration: underline;
				}
			}

			&.user {
				button {
					color: #080840;
				}
			}

			span {
				min-width: 0;
				height: min-content;
				border: 1px solid transparent;
				background-color: transparent;


				border: 1px solid #8080f0;
				background-color: #fcfcff;
			}

			textarea {
				min-width: 0;
				height: min-content;
				border: 1px solid transparent;
				background-color: transparent;

				&:focus {
					border: 1px solid #8080f0;
					background-color: #fcfcff;
				}
			}
		}

		app-trip {
			display: flex;
			flex-direction: column;

			&>header {
				padding: 0.5rem;
				border-radius: 0.5rem;
				color: #e0e0f0;
				background-color: #202050f0;
				position: sticky;
				top: -1.0rem;
				backdrop-filter: blur(3px);

				&>app-name {
					background-color: #c0c0f0;
					color: #202050;
					border-radius: 0.25rem;
					padding: 0.5rem;
					text-transform: uppercase;
					font-weight: 500;
					overflow: hidden;
					min-width: 0;
					text-overflow: ellipsis;
				}

			}
		}

		app-stop {
			padding: 0.2rem;
			display: flex;
			align-items: center;
			gap: 0.5rem;


			&.focus {
				app-name {
					color: #080840;
					font-weight: 500;
					text-decoration: underline;
				}
			}

			app-testa & {
				border-left: 1px solid #404080c0;
				margin-left: 1.0rem;
			}
		}


		app-platform {
			background-color: #cdcdeb;
			color: #404080;
			padding: 0.2rem 0.4rem;
			font-size: 0.8rem;
			font-weight: 600;
		}


		app-transfer {
			color: #404080;
			padding: 0.3rem 0.6rem;
			font-size: 0.8rem;
		}


		app-line {
			font-weight: 600;
			display: flex;
			align-items: center;
			justify-content: center;
			min-width: 2rem;
			padding: 0.2rem;
			color: #e0e0f0;
			background-color: var(--line-color);
			border-radius: 0.2rem;
			font-size: 1.4rem;
		}

		app-side {
			display: flex;
			flex-direction: column;
			background-color: #f0f0ff;
			box-sizing: border-box;

			grid-area: side;
			min-width: 20rem;
			min-height: 20rem;
		}

		app-options {
			display: flex;
			flex-direction: column;
			background-color: #23232f;
			gap: 0.5rem;
			padding: 0.5rem 1.0rem;
			box-sizing: border-box;

			&>app-bar {
				flex-wrap: nowrap;
			}


			span {
				color: #f0f0ff;
			}

			button {
				font-size: 1.4rem;
			}

		}

		app-map {
			display: grid;
			grid-area: map;
			min-width: 8rem;
			min-height: 8rem;
		}


		app-choice {
			cursor: pointer;
			user-select: none;
			display: flex;
			flex-direction: column;
			gap: 0.2rem;

			header {
				color: #000040;
			}

			&:hover {
				header {
					color: #000080;
					text-decoration: underline;
				}
			}
		}

		app-doc {
			box-sizing: border-box;
			display: flex;
			flex-direction: column;
			gap: 0.5rem;
			padding: 0.5rem;
		}

		button {
			font-family: inherit;
			display: flex;
			border-radius: 0.2rem;
			padding: 0.2rem 0.4rem;
			gap: 0.5rem;
			border: 1px solid transparent;
			background-color: #555588;
			color: #f0f0ff;
			cursor: pointer;
			justify-content: center;
			min-width: 2.4rem;

			&.active {
				background-color: #885555;
				color: #fff0f0;
			}
		}

		app-search {
			flex: 1 1 auto;

			input {
				font: inherit;
				border: 0px solid transparent;
				background-color: #c0c0f0;
				border-radius: 0.5rem;
				padding: 0.25rem;
				width: 100%;
				box-sizing: border-box;
			}
		}


		#date {
			font: inherit;
			border: 0px solid transparent;
			background-color: #c0c0f0;
			border-radius: 0.5rem;
			padding: 0.25rem;
			box-sizing: border-box;
		}

		app-goto {
			user-select: none;
			display: inline-block;
			height: 1.5rem;
			width: 3.0rem;
			aspect-ratio: 2/1;
			background-image: url('eye.svg');
			background-repeat: no-repeat;
			background-position: center;
			background-size: 80%;
			border-radius: 0.5rem;
			background-color: #c0c0f080;
		}


		app-preview {
			user-select: none;
			display: inline-block;
			height: 1.5rem;
			width: 3.0rem;
			aspect-ratio: 2/1;
			background-image: url('eye.svg');
			background-repeat: no-repeat;
			background-position: center;
			background-size: 80%;
			border-radius: 0.5rem;
			background-color: #e0e0f020;

			app-stop &:not(.active),
			app-stop-travel &:not(.active) {
				opacity: 0.2;
			}

			&.active {
				background-color: #8080f0;
			}
		}

		@keyframes marquee-content {
			0% {
				transform: translateX(0%);
			}

			20% {
				transform: translateX(-100%);
			}
		}

		app-sub-name {
			//animation: linear 6s marquee-content infinite;
		}

	</style>


</head>

<body>


	<app-main>
		<app-side>
			<app-options>
				<app-bar>
					<button type="button" id="list">&#x25B3;</button>
					<button type="button" id="locate">&#x25C9;</button>
					<button type="button" id="layout">&#x1F5DB;&#x1F5DA;</button>
					<app-search data-target="app-doc > app-trip-ref">
						<input type="text" autocomplete="false" list="search-keywords" autofocus
							placeholder="Lijnen zoeken..." />
						<datalist id="search-keywords"></datalist>
					</app-search>
					<button type="button" id="prev">&#x25C4;</button>
					<span id="step"></span>
					<button type="button" id="next">&#x25BA;</button>
				</app-bar>
				<app-bar id="list-options">
					<input id="date" type="date" /><span id="date-hint"></span>
					<app-spacer></app-spacer>
					<button type="button" id="date_prev">&#x23EE;</button>
					<button type="button" id="date_next">&#x23ED;</button>
				</app-bar>
			</app-options>
			<!--<app-bar>
				<app-toggle>
					<app-toggle-option>Handmatig</app-toggle-option>
					<app-toggle-option>Synchroon</app-toggle-option>
					<app-toggle-option>Locatie</app-toggle-option>
				</app-toggle>
				</app-bar>--!>
			<app-doc></app-doc>
		</app-side>
		<app-map>
		</app-map>
	</app-main>


	<script>
		const POINT_SIZE = 4;
		const POINT_SIZE_IMPORTANT = 6;

		class AppBase extends HTMLElement {
			static _cache = new Map();
			static _count = 0;

			constructor() {
				super();

				this._instance = ++AppBase._count;
			}

			get app_latlon() {
				const lat = this.dataset.lat;
				const lon = this.dataset.lon;

				return this.my_memoize(`latlon`, lat + lon, (_) => {
					return lat && lon && [parseFloat(lat), parseFloat(lon)] || null;
				});
			}

			get app_main() {
				return (this._main ??= document.querySelector(`app-main`));
			}

			get app_doc() {
				return (this._doc ??= document.querySelector(`app-doc`));
			}

			get app_map() {
				return (this._map ??= document.querySelector(`app-map`));
			}

			get app_date() {
				return (this._date ??= document.querySelector(`#date`));
			}

			get app_shape() {
				return this.my_memoize(`shape`, this.dataset.shape, (shape) => {
					return shape.split(`;`).map(x => {
						const [lat, lon] = x.split(`,`);
						return [parseFloat(lat), parseFloat(lon)];
					});
				});
			}

			get app_query_stop_refs() {
				return this.querySelectorAll(`app-stop-ref`);
			}
			
			get app_start() {
				return this.dataset.start;
			}

			get app_end() {
				return this.dataset.end;
			}

			get app_query_stops() {
				return this.querySelectorAll(`app-stop`);
			}

			get my_header() {
				return this.my_memoize(`header`, this, (_) => this.querySelector(`& > header`));
			}

			my_memoize(key, input, fn) {
				const _cache = (this._cache ??= new Map());
				const cur = _cache.get(key);
				if (cur && cur[0] === input) {
					return cur[1];
				}

				const upd = fn(input);
				_cache.set(key, [input, upd]);
				return upd;
			}


			memoize(key, input, fn) {
				const cur = AppBase._cache.get(key);
				if (cur && cur[0] === input) {
					return cur[1];
				}

				const upd = fn(input);
				AppBase._cache.set(key, [input, upd]);
				return upd;
			}

			queue_redraw() {
				queue_redraw(this);
			}

			redraw() {
			}
		}

		class AppMain extends AppBase {
			get app_list() {
				return this.querySelector(`#list`)
			}

			get app_list_options() {
				return this.querySelector(`#list-options`)
			}

			get app_date_hint() {
				return this.querySelector(`#date-hint`)
			}

			get stored_layout() {
				return window.localStorage.getItem(`app-layout`);
			}

			set stored_layout(val) {
				window.localStorage.setItem(`app-layout`, val);
			}

			constructor() {
				super();
				this.shapes = [];
				this.selected_shape = null;

				this.next_shape = this.next_shape.bind(this)
				this.prev_shape = this.prev_shape.bind(this)
				this.close_shape = this.close_shape.bind(this)
				this.on_resize = this.on_resize.bind(this)
				this.today = this.today.bind(this)
				this.date_prev = this.date_prev.bind(this)
				this.date_next = this.date_next.bind(this)
				this.toggle_layout = this.toggle_layout.bind(this)
			}

			connectedCallback() {
				this.resume_layout();
				this.app_date.valueAsDate = new Date();

				this.on_resize();
				window.addEventListener(`resize`, this.on_resize);
				this.querySelector(`#prev`).addEventListener(`click`, this.prev_shape);
				this.querySelector(`#next`).addEventListener(`click`, this.next_shape);
				this.querySelector(`#list`).addEventListener(`click`, this.close_shape);
				this.querySelector(`#date`).addEventListener(`change`, this.close_shape);
				this.querySelector(`#date_prev`).addEventListener(`click`, this.date_prev);
				this.querySelector(`#date_next`).addEventListener(`click`, this.date_next);
				this.querySelector(`#layout`).addEventListener(`click`, this.toggle_layout);

				window.addEventListener(`popstate`, (e) => {
					const d = e.state;

					if (d?.shape) {
						this.open_shape(d.shape);
					}else {
						this.close_shape();
					}
				});

				const hash = location.hash;
				if (hash) {
					const obj = Object.fromEntries(hash.substring(1).split(`&`).map(x=>{
						return x.split(`=`);
					}));

					if (obj?.shape) {
						this.open_shape(obj.shape);
						return;
					}
				}

				this.close_shape();
			}


			disconnectedCallback() {
				window.removeEventListener(`resize`, this.on_resize);
				this.querySelector(`#prev`).removeEventListener(`click`, this.prev_shape);
				this.querySelector(`#next`).removeEventListener(`click`, this.next_shape);
			}

			redraw_step() {
				const num = this.shapes.indexOf(this.selected_shape) + 1;
				const len = this.shapes.length;
				if (num > 0 && len > 0) {
					this.querySelector(`#step`).textContent = `${num}/${len}`
				} else {
					this.querySelector(`#step`).textContent = `${len}`
				}
			}

			store_shapes(shapes) {
				this.shapes = shapes;
				this.redraw_step();
			}

			open_shape(shape) {
				if (!shape) {
					this.close_shape();
					return;
				}

				const src = `static/trips/${shape}.html`;
				const doc = this.app_doc;

				if (this.selected_shape !== shape || doc.dataset.src !== src) {
					this.selected_shape = shape;
					this.last_shape = shape;
					doc.dataset.src = src;
				}
				this.redraw_step();
				this.app_list.style.display = null;
				this.app_list_options.style.display = `none`;
			}

			goto_open_shape(shape) {
				this.open_shape(shape);
				window.history.pushState({ shape }, `Shape: ${shape}`, `#shape=${shape}`);
			}

			close_shape() {
				const doc = this.app_doc;
				const date = this.app_date.valueAsDate ?? new Date();
				const date_str = date.getFullYear().toString().padStart(4, '0') 
					+ (date.getMonth()+1).toString().padStart(2, '0') 
					+ date.getDate().toString().padStart(2, '0');
				const src = `static/date/${date_str}.html`;
				if (this.selected_shape || doc.dataset.src !== src) {
					this.selected_shape = null;
					doc.dataset.src = src;
				}
				this.redraw_step();
				this.app_list.style.display = `none`;
				this.app_list_options.style.display = null;

				const days = [`zo`,`ma`,`di`,`wo`,`do`,`vr`,`za`];
				this.app_date_hint.textContent = `${days[date.getDay()]}`
			}

			today() {
				const date = new Date();
				this.app_date.valueAsDate = date;
				this.last_shape = null;
				this.close_shape();
			}

			date_prev() {
				const date = this.app_date.valueAsDate ?? new Date();
				date.setDate(date.getDate() - 1);
				this.app_date.valueAsDate = date;
				this.last_shape = null;
				this.close_shape();
			}

			date_next() {
				const date = this.app_date.valueAsDate ?? new Date();
				date.setDate(date.getDate() + 1);
				this.app_date.valueAsDate = date;
				this.last_shape = null;
				this.close_shape();
			}

			next_shape() {
				const idx = this.shapes.indexOf(this.selected_shape);
				const next = (idx + 1) % this.shapes.length;

				this.goto_open_shape(this.shapes[next]);
			}

			prev_shape() {
				const idx = this.shapes.indexOf(this.selected_shape);
				const prev = (this.shapes.length + idx - 1) % this.shapes.length;

				this.goto_open_shape(this.shapes[prev]);
			}

			resume_layout() {
				const compact = this.stored_layout === `c`;

				this.classList.toggle(`compact`, compact);
				this.querySelector(`#layout`).classList.toggle(`active`, compact);
				this.querySelector(`#layout`).innerHTML = compact ? `&#x1F5DA;` : `&#x1F5DB;`
				this.on_resize();
			}


			toggle_layout() {
				const compact = this.classList.toggle(`compact`) 

				this.querySelector(`#layout`).classList.toggle(`active`, compact);
				this.querySelector(`#layout`).innerHTML = compact ? `&#x1F5DA;` : `&#x1F5DB;`
				this.on_resize();

				this.stored_layout = compact ? `c` : ``;
			}

			on_resize() {
				this.app_fit();
			}

			app_fit() {
				const bounds = document.documentElement.getBoundingClientRect();
				this.style.height = `${bounds.height}px`;
				document.body.style.height = `${bounds.height}px`;
			}
		}
		window.customElements.define(`app-main`, AppMain);

		class AppGoto extends AppBase {
			constructor() {
				super();
				this.on_click = this.on_click.bind(this);
			}

			connectedCallback() {
				this.addEventListener(`click`, this.on_click);
			}

			disconnectedCallback() {
				this.removeEventListener(`click`, this.on_click);
			}

			on_click(e) {
				e.preventDefault();
				e.stopImmediatePropagation();

				this.app_doc.dataset.src = this.dataset.src;
			}
		}
		window.customElements.define(`app-goto`, AppGoto);

		class AppKeywords extends AppBase {
			get app_keywords() {
				return this.memoize(`keywords`, this.dataset.values, (values) => new Set(values.split(`;`)));
			}

			app_match(fn, res) {
				const fns = new Set(fn);
				for (const k of this.app_keywords) {
					for (const f of fn) {
						if (f.test(k)) {
							fns.delete(f);
							res.add(k);
						}
					}
				}
				if (fns.size === 0) {
					return res;
				}


			}
		}
		window.customElements.define(`app-keywords`, AppKeywords);

		class AppPreview extends AppBase {
			static OPEN = 1;
			static AUTO_CLOSE = 2;
			static MANUAL_CLOSE = 3;

			static is_open(detail) {
				return detail === AppPreview.OPEN;
			}

			static is_manual(detail) {
				return detail === AppPreview.OPEN || detail === AppPreview.MANUAL_CLOSE;
			}

			static is_close(detail) {
				return detail === AppPreview.AUTO_CLOSE || detail === AppPreview.MANUAL_CLOSE;
			}

			get app_active() {
				return this.classList.contains(`active`);
			}

			constructor() {
				super();
				this.on_click = this.on_click.bind(this);
			}

			connectedCallback() {
				this.addEventListener(`click`, this.on_click);
			}

			disconnectedCallback() {
				this.cancel();
				this.removeEventListener(`click`, this.on_click);
			}

			on_click(e) {
				e.preventDefault();
				e.stopImmediatePropagation();

				const should = !this.app_active;

				if (!should) {
					this.close();
				}

				for (const others of document.querySelectorAll(`app-preview.active`)) {
					others.cancel();
				}

				if (should) {
					this.open();
				}
			}

			close() {
				if (this.app_active) {
					return;
				}
				this.classList.remove(`active`);
				this.emit(AppPreview.MANUAL_CLOSE);
			}

			cancel() {
				if (!this.app_active) {
					return;
				}
				this.classList.remove(`active`);
				this.emit(AppPreview.AUTO_CLOSE);
			}

			open() {
				if (this.app_active) {
					return;
				}
				this.classList.add(`active`);
				this.emit(AppPreview.OPEN);
			}

			emit(detail) {
				this.dispatchEvent(new CustomEvent(`preview`, {detail}));
			}
		}
		window.customElements.define(`app-preview`, AppPreview);

		var stopIcon = L.icon({
			iconUrl: 'stop24.png',
			iconSize: [24, 24],
			iconAnchor: [12, 24],
		});
		class AppMap extends AppBase {
			constructor() {
				super();

				this.on_locationerror = this.on_locationerror.bind(this);
				this.on_locationfound = this.on_locationfound.bind(this);
				this.on_moveend = this.on_moveend.bind(this);

				this.osm = L.map(this, {
					doubleClickZoom: false,
				});
			}

			get app_locate() {
				return document.querySelector(`#locate`);
			}

			connectedCallback() {
				this.osm.on(`locationerror`, this.on_locationerror);
				this.osm.on(`locationfound`, this.on_locationfound);
				this.osm.on(`moveend`, this.on_moveend);

				this.osm.setView([51.981776, 5.902942], 12);

				this.tiles = L.tileLayer('https://tile.memomaps.de/tilegen/{z}/{x}/{y}.png', {
					attribution: '&copy; <a href=" https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
				});
				this.tiles.addTo(this.osm);

				this.app_locate.addEventListener(`click`, () => this.locate());

				//this.start_follow();
			}

			disconnectedCallback() {
				this.osm.off(`locationerror`, this.on_locationerror);
				this.osm.off(`locationfound`, this.on_locationfound);
				this.osm.off(`moveend`, this.on_moveend);
			}

			on_locationerror(e) {
				console.error(e);
			}

			on_locationfound(e) {
				console.info(e);
				if (!this.app_locate.classList.contains(`active`)) {
					return;
				}
				to_grid(e.latlng.lat, e.latlng.lng);
				this.osm.flyTo(e.latlng, 15, {animate: true, duration: 1});
			}

			on_moveend() {
				const zoom = this.osm.getZoom();
				const scale = Math.pow(zoom/14, 4);

				this.style.setProperty(`--app-map-font-size`, `${scale}rem`);

				if (!this.app_locate.classList.contains(`active`)) {
					return;
				}
				const latlng = this.osm.getCenter();
				to_grid(latlng.lat, latlng.lng);
			}

			locate() {
				if (this.app_locate.classList.contains(`active`)) {
					this.app_locate.classList.remove(`active`);
				} else {
					this.app_locate.classList.add(`active`);
					this.osm.locate({
						setView: false,
					});
				}
			}


			start_follow() {
				this.osm.locate({
					watch: true,
					setView: false,
				});
			}

			stop_follow() {
				this.osm.stopLocate();
			}
		}
		window.customElements.define(`app-map`, AppMap);


		const redraw_queue = new Set();
		let redraw_queue_pending = null;
		function queue_redraw(el) {
			redraw_queue.add(el);
			if (redraw_queue_pending) {
				return;
			}
			redraw_queue_pending = 1;
			requestAnimationFrame(redraw_queue_worker);
		}
		function redraw_queue_worker() {
			redraw_queue_pending = 0;
			for (const el of redraw_queue) {
				el.redraw();
			}
			redraw_queue.clear();
		}
		

		class AppFav extends AppBase {
			static observedAttributes = ['data-key'];
			static cache = null;

			static get app_selected() {
				if (AppFav.cache) {
				return AppFav.cache;
				}

				const cache = new Set();
				const prefix = `fav-selected-`;
				const prefix_len = prefix.length;
				for (const k in window.localStorage) {
					if (k.startsWith(k) && window.localStorage.getItem(k) === `y`) {
						cache.add(k.substring(prefix_len));
					}
				}
				AppFav.cache = cache;
				return cache;
			}

			get app_selected() {
				const key = this.dataset.key;
				if (!key) {
					return false;
				}

				return AppFav.app_selected.has(key);
			}

			set app_selected(value) {
				const key = this.dataset.key;
				if (!key) {
					return;
				}

				window.localStorage.setItem(`fav-selected-${key}`, value ? `y` : `n`);
				AppFav.cache = null;
			}

			static is_selected(key) {
				return window.localStorage.getItem(`fav-selected-${key}`) === `y`;
			}

			constructor() {
				super();
				this.on_click = this.on_click.bind(this);
			}

			connectedCallback() {
				this.addEventListener(`click`, this.on_click);
				queue_redraw(this);
			}

			disconnectedCallback() {
				this.removeEventListener(`click`, this.on_click);
			}

			redraw() {
				this.classList.toggle(`selected`, this.app_selected);
				this.textContent = this.app_selected ? `+` : `-`;
			}


			attributeChangedCallback(name, oldValue, newValue) {
				queue_redraw(this);
			}

			on_click(e) {
				e.preventDefault();
				e.stopImmediatePropagation();

				this.app_selected = !this.app_selected;

				for (const el of document.querySelectorAll(`app-fav,app-stop,app-stop-travel`)) {
					queue_redraw(el);
				}
			}
		}
		window.customElements.define(`app-fav`, AppFav);

		class AppSearch extends AppBase {
			static observedAttributes = [`data-target`];

			constructor() {
				super();

				this.on_change = this.on_change.bind(this);
			}

			get app_listbtn() {
				return this.querySelector(`#list`);
			}


			get app_input() {
				return this.querySelector(`input`);
			}

			get stored_input() {
				return localStorage.getItem(`app-search-input`) ?? ``;
			}

			set stored_input(val) {
				localStorage.setItem(`app-search-input`, val);
			}

			connectedCallback() {
				this.app_input.value = this.stored_input;

				this.app_input.addEventListener(`change`, this.on_change);
				this.app_input.addEventListener(`input`, this.on_change);
			}


			disconnectedCallback() {
				this.app_input.removeEventListener(`change`, this.on_change);
				this.app_input.removeEventListener(`input`, this.on_change);
			}

			on_change(e) {
				this.app_main.close_shape();
				this.stored_input = this.app_input.value;
				this.app_main.last_shape = null;
				this.apply_search();
			}

			apply_search() {
				const wildcard = (pattern) => {
					if (Number(pattern)) {
						return new RegExp(`(:?\\b${pattern})\\b`, `g`);
					}
					return new RegExp(`(:?\\b${pattern})`, `gi`);
				}

				const wildcard2 = (pattern) => {
					if (Number(pattern)) {
						return new RegExp(`(:?\\b${pattern})([0-9]*)\\b`, `g`);
					}
					return new RegExp(`(:?\\b${pattern})([a-z]*)`, `gi`);
				}

				const value = this.app_input.value;
				const words = value.split(/[\s,.:;]+/).filter(Boolean).map(wildcard);
				const words2 = value.split(/[\s,.:;]+/).filter(Boolean).map(wildcard2);
				const target = document.querySelectorAll(this.dataset.target);
				const matches = new Set();
				const kw_matches_all = new Set();
				const kw_matches = new Set();
				const kw_remainder = new Set();

				for (const el of target) {
					const res = new Set();
					const match = el.app_keywords.app_match(words, res);

					el.classList.toggle(`app-search-visible`, !!match);
					el.classList.toggle(`app-search-hidden`, !match);
					if (match) {
						matches.add(el);
						el.app_keywords.textContent = [...res].join(`, `);
					}

					const match2 = el.app_keywords.app_match(words.slice(0,words.length-1), res);
					if (match2) {
					for (const kw of el.app_keywords.app_keywords) {
						const r = words2[words2.length - 1]?.exec(kw);
						if (r && r[2]) {
							kw_remainder.add(r[2]);
						}
					}
					}
				}

				const skw = document.querySelector(`#search-keywords`);
				skw.innerHTML = ``
				for (const kw of [...kw_remainder].sort().slice(0, 25)) {
					skw.appendChild(h(`option`, `${value}${kw}`));
				}

				const results = [...matches].map(x => x.dataset.shape);
				if (results.length > 0) {
					this.app_main.store_shapes(results);
				}

			}
		}
		window.customElements.define(`app-search`, AppSearch);



		class AppDoc extends AppBase {
			static observedAttributes = [`data-src`];

			constructor() {
				super()
				this.pending = 0;
			}

			disconnectedCallback() {
				this.innerHTML = ``;
			}

			attributeChangedCallback(name, oldValue, newValue) {
				if (name === `data-src` && oldValue !== newValue) {
					this.refresh();
				}
			}

			async refresh() {
				const current = ++this.pending;

				const src = this.dataset.src;
				if (!src) {
					this.innerHTML = `-`;
					return;
				}

				this.innerHTML = `Ophalen van informatie...`

				const response = await fetch(src, {});

				if (this.pending !== current) {
					return;
				}

				if (!response.ok) {
					this.innerHTML = `Foutje`;
					return;
				}

				const text = await response.text();

				this.innerHTML = text;

				for (const s of document.querySelectorAll(`app-search`)) {
					s.apply_search?.();
				}

				const last = this.app_main.last_shape;
				if (last) {
					const match = this.querySelector(`app-trip-ref[data-shape=${JSON.stringify(last)}]`);
					if (match) {
						match.scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"});
						match.focus();
					}
				}

				this.app_map.osm.invalidateSize();
			}
		}
		window.customElements.define(`app-doc`, AppDoc);

		class AppTripRef extends AppBase {
			constructor() {
				super();
				this.on_click = this.on_click.bind(this);
				this.on_hover = this.on_hover.bind(this);
				this.on_leave = this.on_leave.bind(this);
				this.on_preview = this.on_preview.bind(this);
			}

		
			on_preview(e) {
				if (AppPreview.is_close(e.detail)) {
					this.on_leave();
					return;
				}
				
				this.on_hover();
			}

			connectedCallback() {
				this.preview = this.querySelector(`& > app-bar > app-preview`);
				this.preview?.addEventListener(`preview`, this.on_preview);

				const bar = this.querySelector(`& > app-bar`);
				if (bar) {
				bar.insertBefore(this.preview, bar.firstChild);
				}

				this.my_header.addEventListener(`click`, this.on_click);

				this.app_keywords = this.querySelector(`& > app-keywords`);
			}

			disconnectedCallback() {
				const map = this.app_map.osm;
				this.polyline?.forEach(x => x.removeFrom(map));
				this.polyline = [];

				this.my_header?.removeEventListener(`click`, this.on_click);
				this.preview?.removeEventListener(`preview`, this.on_preview);
			}

			on_click(e) {
				e.preventDefault();
				e.stopImmediatePropagation();

				this.app_main.goto_open_shape(this.dataset.shape);
			}

			on_leave() {
				const map = this.app_map.osm;
				this.polyline?.forEach(x => x.removeFrom(map));
				this.polyline = [];

			}

			on_hover() {
				const map = this.app_map.osm;
				const stops1 = [...this.app_query_stop_refs].map(x => x.app_latlon);
				const stops = [...this.app_query_stop_refs].map(x => [...x.app_latlon, x.dataset.id, x.querySelector(`app-name`).textContent,
				]);

				this.polyline?.forEach(x => x.removeFrom(map));

					const p = L.polyline(
						stops1,
						{"weight": 3, "color": "#808080c0"},
					);
					p.addTo(map);
				this.polyline = [
p,
				];
				const bounds = this.polyline[0].getBounds();
				if (bounds.isValid()) {
					map.fitBounds(bounds.pad(0.04), { maxZoom: 16 });
				}

				for (const [lat, lon, key, name, transfer] of stops) {
					const is_fav = AppFav.is_selected(`stop-${key}`);
					const radius = is_fav ? POINT_SIZE_IMPORTANT : POINT_SIZE;
					const color  = is_fav ? `#ff2020c0` : `#2020ff80`;
					const marker_end = L.circleMarker([lat, lon], {
						radius,
						weight: radius * 0.8, 
						fillColor: `#ffffff`,
						fill: true,
						fillOpacity: 1.0,
						color,
					});
					marker_end.addTo(map);
					marker_end.bindTooltip(`${name} (${transfer})`);
					if (is_fav) {
						marker_end.openTooltip();
					}
					this.polyline.push(marker_end);
				}


			}
		}
		window.customElements.define(`app-trip-ref`, AppTripRef);

		class AppCity extends AppBase {
			constructor() {
				super();

				this.on_preview = this.on_preview.bind(this);
			}

			connectedCallback() {
				this.preview = h(`app-preview`);
				this.preview.addEventListener(`preview`, this.on_preview);
				this.appendChild(h(`app-spacer`));
				this.appendChild(this.preview);
			}

			disconnectedCallback() {
				this.removeChild(this.preview);
			}

			app_notes_append(lines) {
				lines.push(`[${this.textContent}]`);
			}

			on_preview(e) {
				if (AppPreview.is_close(e.detail)) {
					this.parentElement?.app_fit?.();
					return;
				}
				const map = this.app_map.osm;

				const res = [];
				for (let cur = this.nextElementSibling; cur.nextElementSibling?.tagName === `APP-STOP` || cur.nextElementSibling?.tagName === `APP-STOP-TRAVEL`; cur = cur.nextElementSibling) {
					res.push(cur.app_latlon);
					cur.on_parent_fit?.();
				}
				const bounds = L.latLngBounds(res);
				if (bounds.isValid()) {
					map.fitBounds(bounds.pad(0.04), { maxZoom: 16 });
				}


			}
		}
		window.customElements.define(`app-city`, AppCity);


		class AppStopRef extends AppBase {
		}
		window.customElements.define(`app-stop-ref`, AppStopRef);

		class AppStopTravel extends AppBase {
			static observedAttributes = [`data-start`, `data-end`];
			get app_storagekey() {
				if (!this.app_start) {
					return;
				}
				if (!this.app_end) {
					return;
				}
				return `stop-travel-${this.app_start}-${this.app_end}`;
			}

			constructor() {
				super();

				this.on_click_button = this.on_click_button.bind(this);
				this.on_click_marker = this.on_click_marker.bind(this);
				this.on_click_tooltip = this.on_click_tooltip.bind(this);
				this.on_pointerdown = this.on_pointerdown.bind(this);
				this.on_hover = this.on_hover.bind(this);
				this.on_out = this.on_out.bind(this);
				this.on_change = this.on_change.bind(this);
				this.on_leave = this.on_leave.bind(this);
				this.on_closed = this.on_closed.bind(this);


				this._button = h(`button`, `notitie aanmaken`);
				this._button.addEventListener(`pointerover`, this.on_hover);
				this._button.addEventListener(`pointerout`, this.on_out);
				this.appendChild(this._button);

				this.preview = h(`app-preview`);
				this.preview.addEventListener(`preview`, (e) => {
					const prev = this.prev_stop?.querySelector(`app-name`)?.textContent ?? `???`;
					const next = this.next_stop?.querySelector(`app-name`)?.textContent ?? `???`;

					if (AppPreview.is_close(e.detail)) {
						this.marker.closeTooltip();
						this.prev_stop?.close_tooltip?.();
						this.next_stop?.close_tooltip?.();

						if (AppPreview.is_manual(e.detail)) {
							this.parentElement?.app_fit?.();
						}
						return;
					}


					this.app_fit();
					//this.marker.openTooltip();
					for (const stop of document.querySelectorAll(`app-stop`)) {
						stop.hide_tooltip();
					}
					this.prev_stop?.show_tooltip?.();
					this.next_stop?.show_tooltip?.();
				});
				this.appendChild(this.preview);
			}

			get_dialog() {
				if (this._dialog) {
					return this._dialog;
				}
				const signs = h(`div`, [...this.querySelectorAll(`app-sign`)]);
				const ta = h(`textarea`, ``);
				ta.autofocus = true;
				this._header = h(`header`, ``);
				this._form = h(`form`, [
					this._header,
					signs,
					ta,
					h(`button`, `OK`),
				]);
				this._form.method = `dialog`;
				this._form.addEventListener(`submit`, () => {
					const text = this._form.querySelector(`textarea`).value;
					const key = this.app_storagekey;
					localStorage.setItem(key, text);

					this.on_closed();
				});
				this._dialog = h(`dialog`, [this._form]);
				this._dialog.addEventListener(`cancel`, this.on_closed);
				this._dialog.addEventListener(`close`, this.on_closed);


			}

			connectedCallback() {
				this.addEventListener(`pointerdown`, this.on_pointerdown);
				this.addEventListener(`pointerup`, this.on_out);
				this._button.addEventListener(`click`, this.on_click_button);
				this.queue_redraw();
			}

			disconnectedCallback() {
				this.removeEventListener(`pointerdown`, this.on_pointerdown);
				this.removeEventListener(`pointerup`, this.on_out);
					this._button.removeEventListener(`click`, this.on_click_button);
				if (this._dialog?.parentElement) {
					document.body.removeChild(this._dialog);
				}

				const map = this.app_map.osm;
				this.marker?.removeFrom(map);
			}

			redraw() {
				const key = this.app_storagekey;
				const text = key && localStorage.getItem(key)?.trim();
				this.classList.toggle(`user`, !!text);
				if (text) {
					this._button.textContent = text;
				} else {
					this._button.textContent = `notitie aanmaken`;
				}

				const map = this.app_map.osm;

				this.marker?.removeFrom(map);


				const shape = this.parentElement.app_shape;
				const fr = L.GeometryUtil.locateOnLine(map, L.polyline(shape), L.latLng(this.app_latlon));

				const fr1 = fr + 0.0001;
				const fr2 = fr - 0.0001;
				const fr11 = L.GeometryUtil.interpolateOnLine(map, shape, fr1).latLng;
				const fr22 = L.GeometryUtil.interpolateOnLine(map, shape, fr2).latLng;

				const color = text ? `#f02020` : `#cccccc`;

				const angle = getAngle([fr22.lat, fr22.lng],[fr11.lat, fr11.lng], -1)
		        const icon = L.divIcon({ 
					className: 'arrow-icon', 
					bgPos: [5, 5], 
					html: `<div style="transform: rotate(${angle}deg) translate(-100%, 0)">▶▶▶</div>`, 
				});
				this.marker = L.marker(this.app_latlon, { icon: icon });

				this.marker.addTo(map);
				this.marker.getElement().style.setProperty(`--app-map-color`, color);
				this.marker.on(`click`, this.on_click_marker)
				this.marker.on(`dblclick`, this.on_click_tooltip);
				this.marker.on(`mouseover`, this.on_hover)
				this.marker.on(`mouseout`, this.on_out)
				this.marker.bindTooltip(`${text || `notitie aanmaken`}`)
				this.marker.getTooltip().on(`click`, this.on_click_tooltip);
				if (text) {
					this.marker.openTooltip();
				}
			}

			on_pointerdown() {
				const map = this.app_map.osm;

				const zoom = map.getZoom();
				const minZoom = 12;
				const maxZoom = 16;

				if (zoom > maxZoom) {
					map.setZoom(maxZoom, { animate: false });
				}

				if (zoom < minZoom) {
					map.setZoom(minZoom, { animate: false });
				}

				map.panTo(this.app_latlon);

				const key = this.app_storagekey;
				const text = key && localStorage.getItem(key)?.trim();

				this.classList.add(`focus`);
				this.marker.getElement().classList.add(`focus`);

				for (const el of document.querySelectorAll(`app-stop`)) {
					el.hide_tooltip();
				}
				this.prev_stop?.show_tooltip?.();
				this.next_stop?.show_tooltip?.();

				}
	
			on_hover() {
				const key = this.app_storagekey;
				const text = key && localStorage.getItem(key)?.trim();

				this.classList.add(`focus`);
				this.marker.getElement().classList.add(`focus`);
			}

			on_out() {
				const key = this.app_storagekey;
				const text = key && localStorage.getItem(key)?.trim();

				this.classList.remove(`focus`);
				this.marker.getElement().classList.remove(`focus`);


			}

			on_parent_fit() {
				const key = this.app_storagekey;
				const text = key && localStorage.getItem(key)?.trim();

				if (text) {
					this.marker.openTooltip();
				}
			}

			app_open() {
				const dialog = this.get_dialog();
				const prev = this.prev_stop?.querySelector(`app-name`)?.textContent ?? `???`;
				const next = this.next_stop?.querySelector(`app-name`)?.textContent ?? `???`;
				this._header.textContent = `${prev} -> ${next}`;
				const textarea = this._form.querySelector(`textarea`);
				textarea.value = localStorage.getItem(this.app_storagekey) ?? ``;
				document.body.appendChild(this._dialog);
				this._dialog.showModal();
				this.app_fit();
				this.prev_stop?.show_tooltip?.();
				this.next_stop?.show_tooltip?.();

				for (const el of this._form.querySelectorAll(`app-sign`)) {
					el.show_marker();
				}

				this.marker.getElement().classList.add(`active`);
			}

			on_closed() {
					queue_redraw(this);
				this.prev_stop?.on_out?.();
				this.next_stop?.on_out?.();
				this.parentElement?.parentElement?.app_fit?.();

				for (const el of this._form.querySelectorAll(`app-sign`)) {
					el.hide_marker();
				}

				this.marker.getElement().classList.remove(`active`);
			}

			app_notes_append(lines) {
				const text = localStorage.getItem(this.app_storagekey);
				if (text) {
					lines.push(text);
				}
			}

			on_click_button(e) {
				e.preventDefault();
				e.stopImmediatePropagation();

				this.app_open();
			}


			on_click_marker(e) {

				if (this.marker.isTooltipOpen()) {
					this.on_click_tooltip();
					return;
				}
				this.scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"});
				this.marker.openTooltip();
			}


			on_click_tooltip(e) {
				this.scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"});
				this.app_open();
			}


			on_leave(e) {
				for (const el of document.querySelectorAll(`app-stop-travel`)) {
					el.queue_redraw();
				}
			}

			on_change(e) {
				const text = e.target.value;
				const key = this.app_storagekey;
				if (!key) {
					return;
				}

				localStorage.setItem(key, text);
			}

			get prev_stop() {
				for (let cur = this.previousElementSibling; cur; cur = cur.previousElementSibling) {
					if (cur.tagName === `APP-STOP`) {
						return cur;
					}
				}

				return null;
			}

			get next_stop() {
				for (let cur = this.nextElementSibling; cur; cur = cur.nextElementSibling) {
					if (cur.tagName === `APP-STOP`) {
						return cur;
					}
				}

				return null;
			}

			app_fit() {
				const map = this.app_map.osm;
				const prev = this.prev_stop;
				if (!prev) {return;}
				const next = this.next_stop;
				if (!next) {return;}

				const llcur = this.app_latlon;
				const llprev = prev.app_latlon;
				const llnext = next.app_latlon;

				if (llcur && llprev && llnext) {
					for (const stop of document.querySelectorAll(`app-stop`)) {
						stop.on_out();
					}
					for (const travel of document.querySelectorAll(`app-stop-travel`)) {
						travel.on_out();
					}
					prev.on_hover();
					next.on_hover();
					this.on_hover();
					const bounds = L.latLngBounds([
						llprev,
						llcur,
						llnext,
					]);
					if (bounds.isValid()) {
					map.fitBounds(bounds.pad(0.12), { maxZoom: 16 });
					}

				}
			}
		}
		window.customElements.define(`app-stop-travel`, AppStopTravel);

		class AppTrip extends AppBase {
			constructor() {
				super();
				this.on_hover = this.on_hover.bind(this);
				this.on_leave = this.on_leave.bind(this);
				this.on_export = this.on_export.bind(this);
				this.on_scroll = this.on_scroll.bind(this);
			}

			connectedCallback() {
				this._scrollContainer = this.parentElement;
				this._scrollContainer.addEventListener(`scroll`, this.on_scroll);

				const map = this.app_map.osm;

				this.polyline?.forEach(x => x.removeFrom(map));
				const shape = this.app_shape;
				this.polyline = [
					L.polyline(
						shape,
						{"weight": 4, "color": "#000080C0"},
					),
				];
				const bounds = this.polyline[0].getBounds();
				if (bounds.isValid()) {
					map.fitBounds(bounds.pad(0.04), { maxZoom: 16 });
				}

				this.polyline?.forEach(x => x.addTo(map));


				this._export = h(`button`, `TXT`);
				this._export.addEventListener(`click`, this.on_export);
				//this.my_header.appendChild(this._export);
					//map.setZoom(15);
		

			}

			on_scroll() {
				//this.current_shape_fr();
			}

			current_shape_fr() {
				const map = this.app_map.osm;
				const container = this.parentElement;
				const view = container.getBoundingClientRect();

				const scrollTop = container.scrollTop;
				const scrollHeight = container.scrollHeight;
				const progress = constrain(scrollTop / (scrollHeight - view.height), 0, 1);

				const shape = this.app_shape;


				const els = [...this.querySelectorAll(`app-stop,app-stop-travel`)].map(el => {
					const top = el.offsetTop;
					const height = el.offsetHeight;
					const middle = top + height * 0.5;
					return [middle, parseFloat(el.dataset.shapeFr)];
				});

				const next = els.findIndex(([m,_]) => m > progress * scrollHeight);
				const start = els[next-1]
				const end = els[next]
				if (start && end) {
					const fr = start[1] + (end[1] - start[1]) * 0.5;
					const iol = L.GeometryUtil.interpolateOnLine(map, shape, fr);
					map.panTo(iol.latLng);
				}
			}

			app_fit() {
				const map = this.app_map.osm;
				const bounds = this.polyline[0]?.getBounds();
				if (bounds?.isValid()) {
					map.fitBounds(bounds.pad(0.04), { maxZoom: 16 });
				}

				for (const el of this.querySelectorAll('app-stop,app-stop-travel')) {
					el.on_parent_fit?.();
				}
			}

			disconnectedCallback() {
				const map = this.app_map.osm;
				this.polyline?.forEach(x => x.removeFrom(map));
				this.polyline = [];
				this._scrollContainer.removeEventListener(`scroll`, this.on_scroll);
			}

			on_leave() {

			}

			on_hover() {

			}

			on_export() {

				const line = this.querySelector(`app-line`).textContent;
				const name = this.querySelector(`app-name`).textContent;
				const lines = [
					`Lijn ${line} - ${name}`,
				];
				for (const el of this.querySelectorAll(`app-city,app-stop:has(app-fav.selected),app-stop-travel`)) {
					el.app_notes_append?.(lines);
				}
				const text = lines.join(`\n`);

				const ta = h(`code`, text);
				const form = h(`form`, [
					ta,
					h(`button`, `OK`),
				]);
				form.method = `dialog`;

				const dialog = h(`dialog`, [form]);
				document.documentElement.appendChild(dialog);
				dialog.showModal();

				navigator.clipboard.writeText(text);
			}
		}
		window.customElements.define(`app-trip`, AppTrip);


		class AppStop extends AppBase {
			constructor() {
				super();

				this.on_click_marker = this.on_click_marker.bind(this);
				this.on_click = this.on_click.bind(this);
				this.on_hover = this.on_hover.bind(this);
				this.on_out = this.on_out.bind(this);
				this.on_preview = this.on_preview.bind(this);
			}




			connectedCallback() {
				this.goto_stop = h(`app-goto`, ``, {
					target: `app-doc`,
					src: `static/stops/${this.dataset.id}.html`,
				});

				this.preview = h(`app-preview`);
				this.preview.addEventListener(`preview`, this.on_preview);

				//this.appendChild(this.goto_stop);

					queue_redraw(this);
				this.addEventListener(`pointerdown`, this.on_click);
				this.addEventListener(`pointerover`, this.on_hover);
				this.addEventListener(`pointerout`, this.on_out);
			}

			disconnectedCallback() {
				const map = this.app_map.osm;
				this.marker?.removeFrom(map);
				this.removeEventListener(`pointerdown`, this.on_click);
				this.removeEventListener(`pointerover`, this.on_hover);
				this.removeEventListener(`pointerout`, this.on_out);
			}

			redraw() {
				const key = this.dataset.id;

				const map = this.app_map.osm;

				this.marker?.removeFrom(map);

				const is_fav = AppFav.is_selected(`stop-${key}`);


				/*
				this.marker = L.circleMarker([lat, lon], {
					icon: stopIcon,
				});
				*/
				const radius = is_fav ? POINT_SIZE_IMPORTANT : POINT_SIZE;
				const color = is_fav ? `#f02020` : `#2020f0`;
				this.marker = L.circleMarker(this.app_latlon, {
					radius,
					weight: radius * 0.8,
					color, 
					fill: true,
					fillColor: `#ffffff`,
					fillOpacity: 1.0,
				});
				this.marker.addTo(map);
				this.marker.on(`click`, this.on_click_marker)
				this.marker.on(`mouseover`, this.on_hover)
				this.marker.on(`mouseout`, this.on_out)

				if (is_fav) {
					this.show_tooltip();
				}
			}

			on_parent_fit() {
				const key = this.dataset.id;
				const is_fav = AppFav.is_selected(`stop-${key}`);
				if (is_fav) {
					this.show_tooltip();
				}
			}

			app_notes_append(lines) {

				lines.push(`${this.querySelector(`app-name`).textContent}`);

			}


		on_click() {
				const map = this.app_map.osm;

				const zoom = map.getZoom();
				const minZoom = 12;
				const maxZoom = 16;

				if (zoom > maxZoom) {
					map.setZoom(maxZoom, { animate: false });
				}

				if (zoom < minZoom) {
					map.setZoom(minZoom, { animate: false });
				}



				map.panTo(this.app_latlon);

				for (const stop of document.querySelectorAll(`app-stop`)) {
					stop.hide_tooltip();
				}
				this.show_tooltip();
			}

			on_hover() {
				this.marker?.setRadius(8);
				this.classList.add(`focus`);
			}

			on_out() {
				const key = this.dataset.id;
				const is_fav = AppFav.is_selected(`stop-${key}`);

				this.marker?.setRadius(is_fav ? POINT_SIZE_IMPORTANT : POINT_SIZE_IMPORTANT);
				this.classList.remove(`focus`);
			}

			on_click_marker() {
				this.scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"});
				this.show_tooltip();
			}

			hide_tooltip() {
				this.marker.closeTooltip();
			}


			show_tooltip() {
				const key = this.dataset.id;
				const is_fav = AppFav.is_selected(`stop-${key}`);

				const name = this.querySelector(`app-name`)?.textContent ?? `?`;
				const platform = this.querySelector(`app-platform`)?.textContent;
				this.marker.bindTooltip(platform ? `[${platform}] ${name}` : name, { className: is_fav ? `app-fav`: undefined });
				this.marker.openTooltip();
			}


			on_preview(e) {
				if (AppPreview.is_close(e.detail)) {
					this.marker.closeTooltip();
					if (AppPreview.is_manual(e.detail)) {
						this.parentElement?.app_fit?.();
					}
					return;
				}

				const map = this.app_map.osm;

				const res = [];

				res.push(this.app_latlon);

				const bounds = L.latLngBounds(res);
				if (bounds.isValid()) {
					map.fitBounds(bounds.pad(0.12), { maxZoom: 16 });
				}
				this.show_tooltip();
			}
		}
		window.customElements.define(`app-stop`, AppStop);


		class AppSign extends AppBase {
			constructor() {
				super();
			}

			connectedCallback() {

			}

			disconnectedCallback() {

			}

			hide_marker() {
				const map = this.app_map.osm;
				this.marker?.removeFrom(map);
			}

			show_marker() {
				const key = this.dataset.id;
				const name = this.textContent ?? `?`;

				const map = this.app_map.osm;

				this.marker?.removeFrom(map);

				const is_fav = AppFav.is_selected(`sign-${key}`);

				this.marker = L.circleMarker(this.app_latlon, {
					radius: POINT_SIZE,
					color: `#102080`,
					fill: `#102080`,
					fillOpacity: 1.0,
				});
				this.marker.addTo(map);
				this.marker.bindTooltip(`${name}`);
				this.marker.openTooltip();
			}
		}
		window.customElements.define(`app-sign`, AppSign);


		function delay(ms) {
			return new Promise((resolve) => {
				setTimeout(resolve);
			});
		}

		function h(kind, els, dataset) {
			const el = document.createElement(kind);
			if (typeof els === `string`) {
				el.textContent = els
			} else if (els) {
				for (const c of els) {
					el.appendChild(c);
				}
			}

			if (dataset) {
				for (const [k, v] of Object.entries(dataset)) {
					el.dataset[k] = v;
				}
			}

			return el;
		}

		function angleFromCoordinate(lat1, long1, lat2, long2) {

			const dLon = (long2 - long1);

			const y = Math.sin(dLon) * Math.cos(lat2);
			const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1)
				* Math.cos(lat2) * Math.cos(dLon);

			let brng = Math.atan2(y, x);

			brng = radians_to_degrees(brng);
			brng = (brng + 360) % 360;
			brng = 360 - brng; // count degrees counter-clockwise - remove to make clockwise

			return brng;
		}

		// Define a function named radians_to_degrees that converts radians to degrees.
		function radians_to_degrees(radians) {
			// Store the value of pi.
			var pi = Math.PI;
			// Multiply radians by 180 divided by pi to convert to degrees.
			return radians * (180 / pi);
		}

		function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
			var R = 6371; // Radius of the earth in km
			var dLat = deg2rad(lat2 - lat1); // deg2rad below
			var dLon = deg2rad(lon2 - lon1);
			var a =
				Math.sin(dLat / 2) * Math.sin(dLat / 2) +
				Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
				Math.sin(dLon / 2) * Math.sin(dLon / 2)
				;
			var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
			var d = R * c; // Distance in km
			return d;
		}

		function deg2rad(deg) {
			return deg * (Math.PI / 180)
		}

		function subdeg(a, b) {
			return Math.min(Math.abs(a - b), 360 - Math.abs(a - b))
		}

		function pairs(p) {
			return Array(p.length - 1).fill(0).map((_, i) => [p[i], p[i + 1]]);
		}


		function look_ahead(p, i, km) {
			for (let j = i + 1; j < p.length; j++) {
				const d = getDistanceFromLatLonInKm(p[i][0], p[i][1],
					p[j][0], p[j][1]); if (d >= km) {
						return p[j];
					}
			}
			return p[p.length - 1];
		}

		function look_behind(p, i, km) {
			for (let j = i - 1; j > -1; j--) {
				const d = getDistanceFromLatLonInKm(p[i][0], p[i][1], p[j][0], p[j][1]);
				if (d >= km) {
					return p[j];
				}
			}
			return p[0];
		}


		function lerp(a, b, t) {
			return (b - a) + d * t;
		}

		function constrain(val, min, max) {
			return Math.min(max, Math.max(min, val));
		}

		function enumerate(arr) {
			return arr.map((v, i) => [i, v]);
		}

		function to_grid(lat, lon) {
			let res_x = 128;
			let res_y = 32;
			let x_start = 51.761483;
			let y_start = 5.585679;
			let x_end = 52.077655;
			let y_end = 6.146368;
			let x_range = x_end - x_start;
			let y_range = y_end - y_start;
			let x_step = x_range / res_x;
			let y_step = y_range / res_y;

			let x = Math.round((lat) / x_step);
			let y = Math.round((lon) / y_step);
			console.log({x,y});
			document.querySelector(`app-doc`).dataset.src = `static/grid/${x}-${y}.html`
		}

		function getAngle([lat1, lon1], [lat2, lon2], coef) {
			var dy = lat2 - lat1;
			var dx = Math.cos(Math.PI / 180 * lat1) * (lon2 - lon1);
			var ang = (Math.atan2(dy, dx) / Math.PI) * 180 * coef;
			return ang;
		}
	</script>
</body>

</html>
