<!DOCTYPE html>
<html lang="en">

<head>
	<base target="_top">
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<title>Lijnverkenning</title>

	<link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" />

	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
		integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
	<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
		integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

	<style>
		html,
		body {
			height: 100%;
			margin: 0;
			font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
		}

		body {
			display: grid;
		}

		dialog:open::backdrop {
			background-color: rgb(0 0 0 / 10%);
		}

		dialog:modal {
			background: #ffffff80;
			backdrop-filter: blur(3px);
			border: 6px solid #00000040;
			border-radius: 3px;
		}

		.leaflet-container {
			max-width: 100%;
			max-height: 100%;
			z-index: 0;
		}

		app-main {
			display: grid;
			grid-template: auto / 1fr 2fr;
			max-height: 100vmin;
		}

		app-main {
			grid-template: "map" "side" 1fr 2fr / auto;

			@media (orientation: portrait) {
				grid-template:
					"map" 1fr
					"side" 2fr / 1fr;
			}
		}

		app-sign {
			display: flex;
			flex-direction: row;
			flex-wrap: wrap;
			gap: 0.25rem;

			app-name {
				color: #102080;
				/*border: 2px solid #ffffff;
				background-color: #102080;
				color: #ffffff;
				padding: 0.25rem;*/
			}

		}

		app-route {
			display: flex;
			flex-direction: column;
			gap: 1rem;
		}


		app-side {
			grid-area: "side";
			max-height: 100vmin;
		}

		app-routes,
		app-trips,
		app-doc {
			flex: 1 1 auto;
			overflow-y: auto;
		}

		app-trip {
			&>header {
				display: flex;
				gap: 0.5rem;
				align-items: center;
			}

			app-city {
				padding-left: 0rem;
			}

			app-stop {
				padding-left: 1rem;
				user-select: none;
			}

		}

		app-spacer {
			flex: 1 1 auto;
		}

		app-trip-ref {
			display: flex;
			flex-direction: row;
			align-items: center;
			justify-items: center;
			flex-wrap: wrap;

			&>header {
				flex: 1 1 100%;
				display: flex;
				gap: 0.5rem;
				align-items: center;
			}

			app-trip-cell {
				flex: 1 0 min-width;
				display: flex;
				flex-direction: row;
				justify-items: flex-end;
				align-items: center;
				flex: 1 0 100%;
				display: flex;
				flex-direction: cell;

				app-city {
					font-weight: inherit;
					color: #40408080;
				}

				app-name {
					color: #404080c0;
				}
			}


			header {}

			app-name {
				flex: 1 0 auto;
			}
		}

		app-fav {
			font-weight: bold;
			display: flex;
			align-items: center;
			justify-content: center;
			min-width: 1rem;
			padding: 0.5rem;
			border-radius: 0.2rem;
			color: #e0e0f0;
			background-color: #202050;

			&.selected {
				color: #f0e0e0;
				background-color: #802020;
			}
		}


		app-city {
			font-weight: bold;
			padding: 0.2rem;
			color: #40408080;
			display: flex;
			flex-direction: row;
			gap: 0.5rem;
			align-items: center;

			app-doc & {}
		}

		app-trip-ref {
			border: 1px solid #77777740;
			border-radius: 0.5rem;
			background-color: #f0f0ff;


			&:hover {
				background-color: #e0e0f0;
			}

			&>header {
				padding: 0.5rem;
				border-radius: 0.5rem;
				color: #e0e0f0;
				background-color: #202050;


				&>app-name {
					background-color: #e0e0f0;
					background-color: #c0c0f0;
					color: #202050;
					border-radius: 0.25rem;
					padding: 0.5rem;
					text-transform: uppercase;
					font-weight: bold;
				}
			}

			app-trip-cell {
				padding-left: 4rem;
			}

			app-preview {
				display: none;
			}
		}

		app-stops {
			display: flex;
			flex-direction: column;
			gap: 0.5rem;
		}

		app-stop-travel {
			padding: 0.2rem;
			padding-left: 3.5rem;

			display: flex;
			flex-direction: row;
			gap: 0.5rem;
			align-items: center;


			button {
				flex: 1 1 auto;
				display: flex;
				justify-content: start;
				border: 1px dotted #c0c0f0;
				background-color: transparent;
				color: #08084060;
				padding: 0.25rem;
			}

			&.focus {
				button {
					font-weight: bold;
					color: #080840;
					text-decoration: underline;
				}
			}

			&.user {
				button {
					color: #080840;
				}
			}

			span {
				min-width: 0;
				height: min-content;
				border: 1px solid transparent;
				background-color: transparent;


				border: 1px solid #8080f0;
				background-color: #fcfcff;
			}

			textarea {
				min-width: 0;
				height: min-content;
				border: 1px solid transparent;
				background-color: transparent;

				&:focus {
					border: 1px solid #8080f0;
					background-color: #fcfcff;
				}
			}
		}

		app-trip {
			display: flex;
			flex-direction: column;

			&>header {
				padding: 1.0rem;
				border-radius: 0.5rem;
				color: #e0e0f0;
				background-color: #202050f0;
				position: sticky;
				top: -1.0rem;
				backdrop-filter: blur(3px);

				&>app-name {
					background-color: #e0e0f0;
					background-color: #c0c0f0;
					color: #202050;
					border-radius: 0.25rem;
					padding: 0.5rem;
					text-transform: uppercase;
					font-weight: bold;
				}
			}
		}

		app-stop {
			padding: 0.2rem;
			display: flex;
			align-items: center;
			gap: 0.5rem;


			&.focus {
				app-name {
					color: #080840;
					font-weight: bold;
					text-decoration: underline;
				}
			}

			app-testa & {
				border-left: 1px solid #404080c0;
				margin-left: 1.0rem;
			}
		}


		app-line {
			font-weight: bold;
			display: flex;
			align-items: center;
			justify-content: center;
			min-width: 2rem;
			padding: 0.2rem;
			border-radius: 0.2rem;
			color: #e0e0f0;
			background-color: #202050;
		}

		app-side {
			grid-area: 1/1;
			display: flex;
			flex-direction: column;
			min-width: 5rem;
			background-color: #f0f0ff;
			gap: 0.5rem;
			padding: 0.5rem;
			box-sizing: border-box;

			&>header {
				font-weight: bold;
			}
		}

		app-notes {
			grid-area: 1/3;
			display: flex;
			flex-direction: column;
			min-width: 5rem;
			background-color: #f0f0ff;
			gap: 0.5rem;
			padding: 0.5rem;

			&>header {
				font-weight: bold;
			}

			textarea {
				flex: 1 1 auto;
			}
		}

		app-map {
			display: grid;
			grid-area: "map";
		}

		app-choice {
			cursor: pointer;
			user-select: none;
			display: flex;
			flex-direction: column;
			gap: 0.2rem;

			header {
				color: #000040;
			}

			&:hover {
				header {
					color: #000080;
					text-decoration: underline;
				}
			}
		}

		app-routes {
			app-choice:not(:has(app-fav.selected)) {
				display: none;
			}
		}


		app-doc {
			display: flex;
			flex-direction: column;
			gap: 0.5rem;
			padding: 0.5rem;
		}

		.app-search-hidden {
			display: none;
		}

		button {
			font-family: inherit;
			display: flex;
			border-radius: 0.2rem;
			padding: 0.5rem 1.0rem;
			gap: 0.5rem;
			border: 1px solid transparent;
			background-color: #505090;
			color: #f0f0ff;
			cursor: pointer;
		}

		app-search {
			display: flex;


			input {
				font: inherit;
				border: 0px solid transparent;
				background-color: #c0c0f0;
				border-radius: 0.5rem;
				padding: 0.25rem;
				flex: 1 1 auto;
			}
		}

		app-preview {
			user-select: none;
			display: inline-block;
			height: 1.5rem;
			width: 3.0rem;
			aspect-ratio: 2/1;
			background-image: url('eye.svg');
			background-repeat: no-repeat;
			background-position: center;
			background-size: 80%;
			border-radius: 0.5rem;
			background-color: #e0e0f020;

			app-stop &:not(.active),
			app-stop-travel &:not(.active) {
				opacity: 0.2;
			}

			&.active {
				background-color: #8080f0;
			}
		}

	</style>


</head>

<body>


	<app-main>
		<app-side>
			<app-search data-target="app-doc > app-trip-ref">
				<input type="text" autocomplete="false" />
			</app-search>
			<app-doc data-src="static/trip-ref.html"></app-doc>
		</app-side>
		<app-map>
		</app-map>
	</app-main>


	<script>
		class AppPreview extends HTMLElement {
			static OPEN = 1;
			static AUTO_CLOSE = 2;
			static MANUAL_CLOSE = 3;

			static is_open(detail) {
				return detail === AppPreview.OPEN;
			}

			static is_manual(detail) {
				return detail === AppPreview.OPEN || detail === AppPreview.MANUAL_CLOSE;
			}

			static is_close(detail) {
				return detail === AppPreview.AUTO_CLOSE || detail === AppPreview.MANUAL_CLOSE;
			}

			constructor() {
				super();
				this.on_click = this.on_click.bind(this);

			}

			connectedCallback() {
				this.addEventListener(`click`, this.on_click);
			}

			disconnectedCallback() {
				this.emit(AppPreview.AUTO_CLOSE);
				this.removeEventListener(`click`, this.on_click);
			}

			on_click() {
				const should = !this.classList.contains(`active`);

				if (!should) {
					this.classList.remove(`active`);
					this.emit(AppPreview.MANUAL_CLOSE);
				}

				for (const others of document.querySelectorAll(`app-preview.active`)) {
					others.cancel();
				}

				if (should) {
					this.classList.add(`active`);
					this.emit(AppPreview.OPEN);
				}
			}

			cancel() {
				if (this.classList.contains(`active`)) {
					this.classList.remove(`active`);
					this.emit(AppPreview.AUTO_CLOSE);
				}
			}

			emit(detail) {
				this.dispatchEvent(new CustomEvent(`preview`, {detail}));
			}
		}
		window.customElements.define(`app-preview`, AppPreview);

		var stopIcon = L.icon({
			iconUrl: 'stop24.png',
			iconSize: [24, 24],
			iconAnchor: [12, 24],
		});
		class AppMap extends HTMLElement {
			constructor() {
				super();

				this.osm = L.map(this);
			}

			connectedCallback() {
				this.osm.setView([51.981776, 5.902942], 12);

				this.tiles = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
					attribution: '&copy; <a href=" https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
				});
				this.tiles.addTo(this.osm);
			}

			start_follow() {
				this.osm.locate({
					watch: true,
					setView: false,
				});
			}
			stop_follow() {
				this.osm.stopLocate();
			}
		}
		window.customElements.define(`app-map`, AppMap);

		class AppFav extends HTMLElement {
			static observedAttributes = ['data-key'];

			get app_selected() {
				const key = this.dataset.key;
				if (!key) {
					return false;
				}

				const value = window.localStorage.getItem(`fav-selected-${key}`);

				return value === `y`;
			}

			set app_selected(value) {
				const key = this.dataset.key;
				if (!key) {
					return;
				}

				window.localStorage.setItem(`fav-selected-${key}`, value ? `y` : `n`);
			}

			static is_selected(key) {
				return window.localStorage.getItem(`fav-selected-${key}`) === `y`;
			}

			constructor() {
				super();
				this.on_click = this.on_click.bind(this);
			}

			connectedCallback() {
				this.addEventListener(`click`, this.on_click);
				this.redraw();
			}

			disconnectedCallback() {
				this.removeEventListener(`click`, this.on_click);
			}

			redraw() {
				this.tabIndex = 0;
				this.classList.toggle(`selected`, this.app_selected);
				this.textContent = this.app_selected ? `+` : `-`;
			}

			attributeChangedCallback(name, oldValue, newValue) {
				this.redraw();
			}

			on_click(e) {
				e.preventDefault();
				e.stopImmediatePropagation();

				this.app_selected = !this.app_selected;
				for (const el of document.querySelectorAll(`app-fav`)) {
					el.redraw();
				}
			}
		}
		window.customElements.define(`app-fav`, AppFav);

		class AppSearch extends HTMLElement {
			static observedAttributes = [`data-target`];

			constructor() {
				super();

				this.on_change = this.on_change.bind(this);
			}

			connectedCallback() {
				this.querySelector(`input`).addEventListener(`change`, this.on_change);
				this.querySelector(`input`).addEventListener(`input`, this.on_change);
			}


			disconnectedCallback() {
				this.querySelector(`input`).removeEventListener(`change`, this.on_change);
				this.querySelector(`input`).removeEventListener(`input`, this.on_change);
			}

			on_change(e) {

				this.apply_search();
			}

			apply_search() {
				const value = this.querySelector(`input`).value;
				const search = value.split(/\s+/).map(x => x.toLowerCase());
				const target = document.querySelectorAll(this.dataset.target);

				for (const el of target) {
					const sources = el.querySelectorAll(`app-name,app-line,app-city,app-stop,app-stop-ref`);
					let match = false;
					for (const s of sources) {
						const src = s.textContent.toLowerCase();
						match |= search.every(si => src.includes(si));
						if (match) {
							break;
						}
					}


					el.classList.toggle(`app-search-visible`, match);
					el.classList.toggle(`app-search-hidden`, !match);
				}
			}
		}
		window.customElements.define(`app-search`, AppSearch);



		class AppDoc extends HTMLElement {
			static observedAttributes = [`data-src`];

			constructor() {
				super()
				this.pending = 0;
			}

			connectedCallback() {
				this.refresh();
			}

			disconnectedCallback() {
				this.innerHTML = ``;
			}

			attributeChangedCallback(name, oldValue, newValue) {
				if (name === `data-src`) {
					this.refresh();
				}
			}

			async refresh() {
				const current = ++this.pending;

				const src = this.dataset.src;
				if (!src) {
					this.innerHTML = `-`;
					return;
				}

				this.innerHTML = `Ophalen van informatie...`

				const response = await fetch(src, {});

				if (this.pending !== current) {
					return;
				}

				if (!response.ok) {
					this.innerHTML = `Foutje`;
					return;
				}

				const text = await response.text();

				this.innerHTML = text;

				for (const s of document.querySelectorAll(`app-search`)) {
					s.apply_search?.();
				}
			}
		}
		window.customElements.define(`app-doc`, AppDoc);

		class AppTripRef extends HTMLElement {
			constructor() {
				super();
				this.on_click = this.on_click.bind(this);
				this.on_hover = this.on_hover.bind(this);
				this.on_leave = this.on_leave.bind(this);
			}

			connectedCallback() {
				this.addEventListener(`click`, this.on_click);
				this.addEventListener(`mouseenter`, this.on_hover);
				this.addEventListener(`mouseleave`, this.on_leave);
			}

			disconnectedCallback() {
				const map = document.querySelector(`app-map`).osm;
				this.polyline?.forEach(x => x.removeFrom(map));
				this.polyline = [];

				this.removeEventListener(`click`, this.on_click);
				this.removeEventListener(`mouseenter`, this.on_hover);
				this.removeEventListener(`mouseleave`, this.on_leave);
			}

			on_click() {
				const doc = document.querySelector(`app-doc`);
				doc.dataset.src = `static/trips/${this.dataset.shape}.html`;
			}

			on_leave() {
				const map = document.querySelector(`app-map`).osm;
				this.polyline?.forEach(x => x.removeFrom(map));
				this.polyline = [];

			}

			on_hover() {
				const map = document.querySelector(`app-map`).osm;
				const stops1 = [...this.querySelectorAll(`app-stop-ref`)].map(x => [parseFloat(x.dataset.lat),
				parseFloat(x.dataset.lon)]);
				const stops = [...this.querySelectorAll(`app-stop-ref`)].map(x => [parseFloat(x.dataset.lat),
				parseFloat(x.dataset.lon), x.dataset.id, x.querySelector(`app-name`).textContent,
				]);

				this.polyline?.forEach(x => x.removeFrom(map));

				this.polyline = [
					L.polyline(
						stops1,
						{"weight": 3, "color": "#808080c0"},
					),
				];
				const bounds = this.polyline[0].getBounds();
				if (bounds.isValid()) {
					map.fitBounds(bounds, {maxZoom: 16});
				}

				for (const [lat, lon, key, name, transfer] of stops) {
					const is_fav = AppFav.is_selected(`stop-${key}`);
					const marker_end = L.circleMarker([lat, lon], {
						radius: is_fav ? 6 : 4, color: is_fav ?
							`#ff2020c0` : `#2020ff80`
					});
					marker_end.addTo(map);
					marker_end.bindTooltip(`${name} (${transfer})`);
					if (is_fav) {
						marker_end.openTooltip();
					}
					this.polyline.push(marker_end);
				}


				this.polyline?.forEach(x => x.addTo(map));
			}
		}
		window.customElements.define(`app-trip-ref`, AppTripRef);

		class AppCity extends HTMLElement {

			connectedCallback() {
				this.preview = h(`app-preview`);
				this.preview.addEventListener(`preview`, (e) => {
					if (e.detail === AppPreview.MANUAL_CLOSE) {
						this.parentElement?.app_fit?.();
						return;
					}
					const map = document.querySelector(`app-map`).osm;

					const res = [];
					for (let cur = this.nextElementSibling; cur.nextElementSibling?.tagName === `APP-STOP` || cur.nextElementSibling?.tagName === `APP-STOP-TRAVEL`; cur = cur.nextElementSibling) {
						res.push([parseFloat(cur.dataset.lat), parseFloat(cur.dataset.lon)]);
						cur.on_parent_fit?.();
					}
					const bounds = L.latLngBounds(res);
					if (bounds.isValid()) {
						map.fitBounds(bounds, {maxZoom: 16});
					}


				});
				this.appendChild(h(`app-spacer`));
				this.appendChild(this.preview);
			}

			disconnectedCallback() {
				this.removeChild(this.preview);
			}

			app_notes_append(lines) {
				lines.push(`[${this.textContent}]`);
			}
		}
		window.customElements.define(`app-city`, AppCity);

		class AppStopTravel extends HTMLElement {
			static observedAttributes = [`data-start`, `data-end`];

			get app_start() {
				return this.dataset.start;
			}

			get app_end() {
				return this.dataset.end;
			}

			get app_storagekey() {
				if (!this.app_start) {
					return;
				}
				if (!this.app_end) {
					return;
				}
				return `stop-travel-${this.app_start}-${this.app_end}`;
			}

			constructor() {
				super();

				this.on_click_button = this.on_click_button.bind(this);
				this.on_click_marker = this.on_click_marker.bind(this);
				this.on_click_tooltip = this.on_click_tooltip.bind(this);
				this.on_hover = this.on_hover.bind(this);
				this.on_out = this.on_out.bind(this);
				this.on_change = this.on_change.bind(this);
				this.on_leave = this.on_leave.bind(this);
				this.on_closed = this.on_closed.bind(this);
				this._button = h(`button`, `notitie aanmaken`);
				this._button.addEventListener(`pointerover`, this.on_hover);
				this._button.addEventListener(`pointerout`, this.on_out);
				const signs = h(`div`, [...this.querySelectorAll(`app-sign`)]);
				const ta = h(`textarea`, ``);
				ta.autofocus = true;
				this._header = h(`header`, ``);
				this._form = h(`form`, [
					this._header,
					signs,
					ta,
					h(`button`, `OK`),
				]);
				this._form.method = `dialog`;
				this._form.addEventListener(`submit`, () => {
					const text = this._form.querySelector(`textarea`).value;
					const key = this.app_storagekey;
					localStorage.setItem(key, text);

					this.on_closed();
				});
				this._dialog = h(`dialog`, [this._form]);
				this._dialog.addEventListener(`cancel`, this.on_closed);
				this._dialog.addEventListener(`close`, this.on_closed);

				this.appendChild(this._button);

				this.preview = h(`app-preview`);
				this.preview.addEventListener(`preview`, (e) => {


					const prev = this.prev_stop?.querySelector(`app-name`)?.textContent ?? `???`;
					const next = this.next_stop?.querySelector(`app-name`)?.textContent ?? `???`;

					if (AppPreview.is_close(e.detail)) {
						this.marker.closeTooltip();
						this.prev_stop?.close_tooltip?.();
						this.next_stop?.close_tooltip?.();

						if (AppPreview.is_manual(e.detail)) {
							this.parentElement?.app_fit?.();
						}
						return;
					}


					this.app_fit();
					//this.marker.openTooltip();
					this.prev_stop?.show_tooltip?.();
					this.next_stop?.show_tooltip?.();

					for (const el of this._form.querySelectorAll(`app-sign`)) {
						el.show_marker();
					}
				});
				this.appendChild(this.preview);
			}

			connectedCallback() {
				this._button.addEventListener(`click`, this.on_click_button);
				this.redraw();
				document.body.appendChild(this._dialog);
			}

			disconnectedCallback() {
				this._button.removeEventListener(`click`, this.on_click_button);
				document.body.removeChild(this._dialog);

				const map = document.querySelector(`app-map`).osm;
				this.marker?.removeFrom(map);
			}

			redraw() {
				const key = this.app_storagekey;
				const text = key && localStorage.getItem(key)?.trim();
				this.classList.toggle(`user`, !!text);
				if (text) {
					this._button.textContent = text;
				} else {
					this._button.textContent = `notitie aanmaken`;
				}

				const lat = this.dataset.lat;
				const lon = this.dataset.lon;

				const map = document.querySelector(`app-map`).osm;

				this.marker?.removeFrom(map);

				this.marker = L.circleMarker([lat, lon], {
					radius: text ? 8 : 4,
					color: `#202020c0`,
					fill: true,
					fillOpacity: 0.8,
					fillColor: text ? `#c020ff` : `#202020`
				});
				this.marker.addTo(map);
				this.marker.on(`click`, this.on_click_marker)
				this.marker.on(`dblclick`, this.on_click_tooltip);
				this.marker.on(`mouseover`, this.on_hover)
				this.marker.on(`mouseout`, this.on_out)
				this.marker.bindTooltip(`${text ?? `notitie aanmaken`}`)
				this.marker.getTooltip().on(`click`, this.on_click_tooltip);
				if (text) {
					this.marker.openTooltip();
				}
			}


			on_hover() {
				const key = this.app_storagekey;
				const text = key && localStorage.getItem(key)?.trim();
				this.marker.setRadius(12);
				this.classList.add(`focus`);
			}

			on_out() {
				const key = this.dataset.id;
				const text = key && localStorage.getItem(key)?.trim();
				this.marker.setRadius(text ? 8 : 4);
				this.classList.remove(`focus`);
			}

			on_parent_fit() {
				const key = this.dataset.id;
				const text = key && localStorage.getItem(key)?.trim();
				if (text) {
					this.marker.openTooltip();
				}
			}

			app_open() {
				const prev = this.prev_stop?.querySelector(`app-name`)?.textContent ?? `???`;
				const next = this.next_stop?.querySelector(`app-name`)?.textContent ?? `???`;
				this._header.textContent = `${prev} -> ${next}`;
				const textarea = this._form.querySelector(`textarea`);
				textarea.value = localStorage.getItem(this.app_storagekey) ?? ``;
				this._dialog.showModal();
				this.app_fit();
				this.prev_stop?.show_tooltip?.();
				this.next_stop?.show_tooltip?.();

				for (const el of this._form.querySelectorAll(`app-sign`)) {
					el.show_marker();
				}
			}

			on_closed() {
				this.redraw();
				this.prev_stop?.on_out?.();
				this.next_stop?.on_out?.();
				this.parentElement?.parentElement?.app_fit?.();

				for (const el of this._form.querySelectorAll(`app-sign`)) {
					el.hide_marker();
				}
			}

			app_notes_append(lines) {
				const text = localStorage.getItem(this.app_storagekey);
				if (text) {
					lines.push(text);
				}
			}

			on_click_button(e) {
				this.app_open();
			}


			on_click_marker(e) {

				if (this.marker.isTooltipOpen()) {
					this.on_click_tooltip();
					return;
				}
				this.scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"});
				this.focus();
				this.marker.openTooltip();
			}


			on_click_tooltip(e) {
				this.scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"});
				this.focus();
				this.app_open();
			}


			on_leave(e) {
				for (const el of document.querySelectorAll(`app-stop-travel`)) {
					el.redraw();
				}
			}

			on_change(e) {
				const text = e.target.value;
				const key = this.app_storagekey;
				if (!key) {
					return;
				}

				localStorage.setItem(key, text);
			}

			get prev_stop() {
				return this.previousElementSibling;
			}

			get next_stop() {
				return this.nextElementSibling;
			}

			app_fit() {
				const map = document.querySelector(`app-map`).osm;
				const prev = this.previousElementSibling;
				if (!prev) {return;}
				const next = this.nextElementSibling;
				if (!next) {return;}

				const lat = this.dataset.lat;
				const lon = this.dataset.lon;
				const plat = prev.dataset.lat;
				const plon = prev.dataset.lon;
				const nlat = next.dataset.lat;
				const nlon = next.dataset.lon;

				if (plat && plon && nlat && nlon) {
					prev.on_hover();
					next.on_hover();
					const bounds = L.latLngBounds([
						[parseFloat(plat), parseFloat(plon),],
						[parseFloat(lat), parseFloat(lon),],
						[parseFloat(nlat), parseFloat(nlon),],
					]);
					if (bounds.isValid()) {
						map.fitBounds(bounds, {maxZoom: 18});
					}

				}
			}
		}
		window.customElements.define(`app-stop-travel`, AppStopTravel);

		class AppTrip extends HTMLElement {
			constructor() {
				super();
				this.on_hover = this.on_hover.bind(this);
				this.on_leave = this.on_leave.bind(this);
			}

			connectedCallback() {
				this.addEventListener(`mouseenter`, this.on_hover);
				this.addEventListener(`mouseleave`, this.on_leave);
				const b = h(`button`, `<`);
				b.type = `button`;
				b.onclick = () => {
					const doc = document.querySelector(`app-doc`);
					doc.dataset.src = `static/trip-ref.html`;
				};
				const header = this.querySelector(`header`);
				header.insertBefore(b, header.firstChild);

				const map = document.querySelector(`app-map`).osm;
				const stops1 = [...this.querySelectorAll(`app-stop`)].map(x => [parseFloat(x.dataset.lat),
				parseFloat(x.dataset.lon)]);
				const stops = [...this.querySelectorAll(`app-stop`)].map(x => [parseFloat(x.dataset.lat),
				parseFloat(x.dataset.lon), x.dataset.id, x.querySelector(`app-name`).textContent,
				x.querySelector(`app-transfer`).textContent]);
				const shape = this.dataset.shape.split(`;`).map(x => {
					const [lat, lon] = x.split(`,`);
					return [parseFloat(lat), parseFloat(lon)];
				});

				this.polyline?.forEach(x => x.removeFrom(map));

				this.polyline = [
					L.polyline(
						shape,
						{"weight": 3, "color": "#808080c0"},
					),
				];
				const bounds = this.polyline[0].getBounds();
				if (bounds.isValid()) {
					map.fitBounds(bounds, {maxZoom: 16});
				}

				this.polyline?.forEach(x => x.addTo(map));


				this._export = h(`button`, `TXT`);
				this._export.addEventListener(`click`, () => {
					const line = this.querySelector(`app-line`).textContent;
					const name = this.querySelector(`app-name`).textContent;
					const lines = [
						`Lijn ${line} - ${name}`,
					];
					for (const el of this.querySelectorAll(`app-city,app-stop:has(app-fav.selected),app-stop-travel`)) {
						el.app_notes_append?.(lines);
					}
					const text = lines.join(`\n`);

					const ta = h(`textarea`, text);
					ta.rows = 10;
					ta.cols = 40;
					const form = h(`form`, [
						ta,
						h(`button`, `OK`),
					]);
					form.method = `dialog`;

					const dialog = h(`dialog`, [form]);
					document.documentElement.appendChild(dialog);
					dialog.showModal();

					navigator.clipboard.writeText(text);
				});
				this.querySelector(`header`).appendChild(this._export);
			}

			app_fit() {
				const map = document.querySelector(`app-map`).osm;
				const bounds = this.polyline[0]?.getBounds();
				if (bounds?.isValid()) {
					map.fitBounds(bounds, {maxZoom: 16});
				}

				for (const el of this.querySelectorAll('app-stop,app-stop-travel')) {
					el.on_parent_fit?.();
				}
			}

			disconnectedCallback() {
				const map = document.querySelector(`app-map`).osm;
				this.polyline?.forEach(x => x.removeFrom(map));
				this.polyline = [];

			}

			on_leave() {

			}

			on_hover() {

			}
		}
		window.customElements.define(`app-trip`, AppTrip);


		class AppStopRef extends HTMLElement {
			constructor() {
				super();

				this.on_hover = this.on_hover.bind(this);
				this.on_out = this.on_out.bind(this);
			}

			connectedCallback() {
				this.addEventListener(`pointerover`, this.on_hover);
				this.addEventListener(`pointerout`, this.on_out);
			}

			disconnectedCallback() {
				const map = document.querySelector(`app-map`).osm;
				this.marker?.removeFrom(map);
				this.removeEventListener(`pointerover`, this.on_hover);
				this.removeEventListener(`pointerout`, this.on_out);
			}

			redraw() {

				const key = this.dataset.id;
				const lat = this.dataset.lat;
				const lon = this.dataset.lon;
				const name = this.querySelector(`app-name`)?.textContent ?? `?`;
				const transfer = this.querySelector(`app-transfer`)?.textContent ?? `?`;

				const map = document.querySelector(`app-map`).osm;

				this.marker?.removeFrom(map);

				const is_fav = AppFav.is_selected(`stop-${key}`);

				this.tabIndex = 0;
				this.marker = L.circleMarker([lat, lon], {
					radius: is_fav ? 6 : 4, color: is_fav ?
						`#ff2020c0` : `#2020ff80`
				});
				this.marker.addTo(map);
				this.marker.bindTooltip(`${name} (${transfer})`);
				if (is_fav) {
					this.marker.openTooltip();
				}
			}

			on_hover() {
				this.redraw();
			}

			on_out() {
				const map = document.querySelector(`app-map`).osm;
				this.marker?.removeFrom(map);

			}
		}
		window.customElements.define(`app-stop-ref`, AppStopRef);



		class AppStop extends HTMLElement {
			constructor() {
				super();

				this.on_click_marker = this.on_click_marker.bind(this);
				this.on_hover = this.on_hover.bind(this);
				this.on_out = this.on_out.bind(this);
			}

			connectedCallback() {

				this.preview = h(`app-preview`);
				this.preview.addEventListener(`preview`, (e) => {
					if (AppPreview.is_close(e.detail)) {
						this.marker.closeTooltip();
						if (AppPreview.is_manual(e.detail)) {
							this.parentElement?.app_fit?.();
						}
						return;
					}

					const map = document.querySelector(`app-map`).osm;

					const res = [];

					res.push([parseFloat(this.dataset.lat), parseFloat(this.dataset.lon)]);

					const bounds = L.latLngBounds(res);
					if (bounds.isValid()) {
						map.fitBounds(bounds, {maxZoom: 16});
					}
					this.marker.openTooltip();


				});
				this.appendChild(h(`app-spacer`));
				this.appendChild(this.preview);
				this.redraw();
				this.addEventListener(`pointerover`, this.on_hover);
				this.addEventListener(`pointerout`, this.on_out);
			}

			disconnectedCallback() {
				const map = document.querySelector(`app-map`).osm;
				this.marker?.removeFrom(map);
				this.removeEventListener(`pointerover`, this.on_hover);
				this.removeEventListener(`pointerout`, this.on_out);
			}

			redraw() {
				const key = this.dataset.id;
				const lat = this.dataset.lat;
				const lon = this.dataset.lon;
				const name = this.querySelector(`app-name`)?.textContent ?? `?`;
				const transfer = this.querySelector(`app-transfer`)?.textContent ?? `?`;

				const map = document.querySelector(`app-map`).osm;

				this.marker?.removeFrom(map);

				const is_fav = AppFav.is_selected(`stop-${key}`);

				this.tabIndex = 0;

				/*
				this.marker = L.circleMarker([lat, lon], {
					icon: stopIcon,
				});
				*/
				this.marker = L.circleMarker([lat, lon], {
					radius: is_fav ? 6 : 4, color: is_fav ?
						`#ff2020c0` : `#2020ff80`
				});
				this.marker.addTo(map);
				this.marker.on(`click`, this.on_click_marker)
				this.marker.on(`mouseover`, this.on_hover)
				this.marker.on(`mouseout`, this.on_out)
				this.marker.bindTooltip(`${name}`);
				if (is_fav) {
					this.marker.openTooltip();
				}
			}

			on_parent_fit() {
				const key = this.dataset.id;
				const is_fav = AppFav.is_selected(`stop-${key}`);
				if (is_fav) {
					this.marker.openTooltip();
				}
			}

			app_notes_append(lines) {

				lines.push(`${this.querySelector(`app-name`).textContent}`);

			}


			on_hover() {
				this.marker.setRadius(12);
				this.classList.add(`focus`);
			}

			on_click_marker() {
				this.scrollIntoView({behavior: "smooth", block: "center", inline: "nearest"});
				this.focus();
			}

			hide_tooltip() {
				this.marker.closeTooltip();
			}


			show_tooltip() {
				this.marker.openTooltip();
			}

			on_out() {
				const key = this.dataset.id;
				const is_fav = AppFav.is_selected(`stop-${key}`);

				this.marker.setRadius(is_fav ? 6 : 4);
				this.classList.remove(`focus`);
			}
		}
		window.customElements.define(`app-stop`, AppStop);


		class AppSign extends HTMLElement {
			constructor() {
				super();
			}

			connectedCallback() {

			}

			disconnectedCallback() {

			}

			hide_marker() {
				const map = document.querySelector(`app-map`).osm;
				this.marker?.removeFrom(map);
			}

			show_marker() {
				const key = this.dataset.id;
				const lat = this.dataset.lat;
				const lon = this.dataset.lon;
				const name = this.textContent ?? `?`;

				const map = document.querySelector(`app-map`).osm;

				this.marker?.removeFrom(map);

				const is_fav = AppFav.is_selected(`sign-${key}`);

				this.tabIndex = 0;
				this.marker = L.circleMarker([lat, lon], {
					radius: 4,
					color: `#102080`,
					fill: `#102080`,
					fillOpacity: 1.0,
				});
				this.marker.addTo(map);
				this.marker.bindTooltip(`${name}`);
				this.marker.openTooltip();
			}
		}
		window.customElements.define(`app-sign`, AppSign);


		function delay(ms) {
			return new Promise((resolve) => {
				setTimeout(resolve);
			});
		}

		function h(kind, els, dataset) {
			const el = document.createElement(kind);
			if (typeof els === `string`) {
				el.textContent = els
			} else if (els) {
				for (const c of els) {
					el.appendChild(c);
				}
			}

			if (dataset) {
				for (const [k, v] of Object.entries(dataset)) {
					el.dataset[k] = v;
				}
			}

			return el;
		}

		function angleFromCoordinate(lat1, long1, lat2, long2) {

			const dLon = (long2 - long1);

			const y = Math.sin(dLon) * Math.cos(lat2);
			const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1)
				* Math.cos(lat2) * Math.cos(dLon);

			let brng = Math.atan2(y, x);

			brng = radians_to_degrees(brng);
			brng = (brng + 360) % 360;
			brng = 360 - brng; // count degrees counter-clockwise - remove to make clockwise

			return brng;
		}

		// Define a function named radians_to_degrees that converts radians to degrees.
		function radians_to_degrees(radians) {
			// Store the value of pi.
			var pi = Math.PI;
			// Multiply radians by 180 divided by pi to convert to degrees.
			return radians * (180 / pi);
		}

		function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
			var R = 6371; // Radius of the earth in km
			var dLat = deg2rad(lat2 - lat1); // deg2rad below
			var dLon = deg2rad(lon2 - lon1);
			var a =
				Math.sin(dLat / 2) * Math.sin(dLat / 2) +
				Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
				Math.sin(dLon / 2) * Math.sin(dLon / 2)
				;
			var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
			var d = R * c; // Distance in km
			return d;
		}

		function deg2rad(deg) {
			return deg * (Math.PI / 180)
		}

		function subdeg(a, b) {
			return Math.min(Math.abs(a - b), 360 - Math.abs(a - b))
		}

		function pairs(p) {
			return Array(p.length - 1).fill(0).map((_, i) => [p[i], p[i + 1]]);
		}


		function look_ahead(p, i, km) {
			for (let j = i + 1; j < p.length; j++) {
				const d = getDistanceFromLatLonInKm(p[i][0], p[i][1],
					p[j][0], p[j][1]); if (d >= km) {
						return p[j];
					}
			}
			return p[p.length - 1];
		}

		function look_behind(p, i, km) {
			for (let j = i - 1; j > -1; j--) {
				const d = getDistanceFromLatLonInKm(p[i][0], p[i][1], p[j][0], p[j][1]);
				if (d >= km) {
					return p[j];
				}
			}
			return p[0];
		}


		function lerp(a, b, t) {
			return (b - a) + d * t;
		}

		function constrain(val, min, max) {
			return Math.min(max, Math.max(min, val));
		}

		function enumerate(arr) {
			return arr.map((v, i) => [i, v]);
		}
	</script>
</body>

</html>
